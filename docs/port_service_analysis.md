# 端口服务分析功能

## 功能说明

此功能可以分析每台服务器**实际正在使用的端口号**，并列出对应的运行服务，生成详细的报告。**支持去重统计，避免相同端口重复计算**。

## 主要功能

### 1. 端口服务信息收集
- **监听端口**: 服务器上所有实际监听的端口
- **端口协议**: TCP/UDP协议类型
- **服务进程**: 占用端口的进程名和PID
- **系统服务**: 运行的系统服务状态

### 2. 智能服务识别
自动识别常见端口对应的服务：
- 22 → SSH
- 80 → HTTP
- 443 → HTTPS
- 3306 → MySQL
- 5432 → PostgreSQL
- 6379 → Redis
- 8080 → HTTP Alt
- 9000 → Jenkins
- 27017 → MongoDB

### 3. 去重统计功能
- **端口去重**: 每台服务器内相同端口只统计一次
- **服务去重**: 每台服务器内相同服务只统计一次
- **全局统计**: 显示端口和服务在多台服务器上的使用频率

## 使用方法

### 1. 收集端口服务信息

```bash
# 收集所有资产信息（包括端口服务）
ansible-playbook site_python27.yml --tags asset

# 仅收集端口服务信息
ansible-playbook site_python27.yml --tags ports,services,processes
```

### 2. 快速查看端口服务

```bash
# 快速查看每台服务器的端口和服务
./scripts/quick_port_check.sh
```

**输出示例**:
```
=== 服务器: server1 (IP: 193.0.20.98) ===
【实际监听的端口】
----------------------------------------
端口 22 (tcp) -> sshd (PID: 1234)
        常见服务: SSH
端口 80 (tcp) -> nginx (PID: 5678)
        常见服务: HTTP
端口 3306 (tcp) -> mysqld (PID: 9012)
        常见服务: MySQL
总计: 3 个唯一端口

【运行的系统服务】
----------------------------------------
sshd -> running
nginx -> running
mysql -> running
总计: 3 个唯一服务

端口服务统计 (去重):
==========================================
server1: 3 个唯一监听端口
server1: 3 个唯一运行服务

总计 (去重):
  服务器数: 1
  总唯一端口数: 3
  总唯一服务数: 3
```

### 3. 生成详细分析报告

```bash
# 生成详细的端口服务分析报告
./scripts/analyze_port_services.sh
```

**生成的文件**:
- `/tmp/port_service_analysis/port_service_analysis_时间戳.txt` - 文本报告
- `/tmp/port_service_analysis/port_service_analysis_时间戳.json` - JSON报告
- `/tmp/port_service_analysis/port_service_analysis_时间戳.csv` - CSV报告

## 报告内容

### 1. 文本报告
包含：
- 每台服务器的详细端口列表（去重）
- 端口对应的服务名和进程信息
- 运行的系统服务列表（去重）
- 端口服务统计汇总（去重）
- 常用端口服务映射参考

### 2. JSON报告
结构化数据，便于程序处理：
```json
{
  "report_info": {
    "generated_at": "2024-01-01 12:00:00",
    "total_servers": 3,
    "report_type": "port_service_analysis"
  },
  "servers": [
    {
      "server": "server1",
      "ip": "193.0.20.98",
      "port": "22",
      "protocol": "tcp",
      "service": "sshd",
      "process": "sshd",
      "pid": "1234",
      "status": "监听"
    }
  ]
}
```

### 3. CSV报告
表格格式，便于导入Excel：
```csv
服务器名,IP地址,端口号,协议,服务名,进程名,PID,状态
server1,193.0.20.98,22,tcp,sshd,sshd,1234,监听
server1,193.0.20.98,80,tcp,nginx,nginx,5678,监听
```

## 去重统计特性

### 1. 单服务器去重
- 同一台服务器上相同的端口只统计一次
- 同一台服务器上相同的服务只统计一次
- 避免因多个进程使用同一端口导致的重复统计

### 2. 全局使用频率统计
- 显示端口在多台服务器上的使用频率
- 显示服务在多台服务器上的运行频率
- 帮助识别常用的端口和服务

### 3. 统计示例
```
端口使用频率统计:
----------------------------------------
端口 22: 在 3 台服务器上使用
端口 80: 在 2 台服务器上使用

服务使用频率统计:
----------------------------------------
服务 sshd: 在 3 台服务器上运行
服务 nginx: 在 2 台服务器上运行
```

## 快速查询命令

### 1. 查看特定端口
```bash
# 查看SSH端口(22)
grep -r ':22' /tmp/port_service_ps_*.txt

# 查看Web服务端口(80,443)
grep -r ':80\|:443' /tmp/port_service_ps_*.txt

# 查看数据库端口
grep -r ':3306\|:5432\|:6379\|:27017' /tmp/port_service_ps_*.txt
```

### 2. 查看所有监听端口
```bash
grep -r 'LISTEN' /tmp/port_service_ps_*.txt
```

### 3. 查看运行服务
```bash
grep -r 'running' /tmp/port_service_ps_*.txt
```

## 统计信息

脚本会自动统计：
- 每台服务器的唯一监听端口数
- 每台服务器的唯一运行服务数
- 所有服务器的汇总统计（去重）
- 端口和服务的使用频率统计

## 实际应用场景

### 1. 安全审计
- 检查未授权的开放端口
- 识别异常的服务进程
- 验证端口服务配置
- 避免重复统计导致的误判

### 2. 系统监控
- 监控关键服务的运行状态
- 跟踪端口使用情况
- 发现服务异常
- 准确统计资源使用

### 3. 资产管理
- 记录服务器端口配置
- 生成端口服务清单
- 便于系统维护
- 避免重复记录

### 4. 故障排查
- 快速定位端口冲突
- 检查服务是否正常监听
- 分析进程端口占用
- 准确识别问题端口

## 注意事项

1. **权限要求**: 某些端口信息可能需要管理员权限
2. **实时性**: 收集的信息是执行时的快照
3. **网络连接**: 需要确保与目标服务器的网络连接正常
4. **命令可用性**: 脚本会自动检测可用的系统命令
5. **去重逻辑**: 基于端口号和服务名进行去重，确保统计准确性

## 故障排除

### 1. 端口信息为空
- 检查网络连接
- 确认SSH连接权限
- 验证目标服务器可访问

### 2. 服务信息不完整
- 检查是否有足够权限
- 确认Python解释器路径
- 验证系统命令可用性

### 3. 报告生成失败
- 检查磁盘空间
- 确认目录写入权限
- 验证脚本执行权限

### 4. 去重统计异常
- 检查端口数据格式
- 确认服务名称一致性
- 验证统计逻辑正确性 